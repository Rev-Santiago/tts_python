<!DOCTYPE html>
<html>
<head>
    <title>TTS Local Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea, select, button { margin-bottom: 10px; width: 100%; max-width: 400px; padding: 8px; }
    </style>
</head>
<body>
    <h2>TTS REST API Test</h2>
    
    <label for="text">Text to synthesize:</label><br>
    <textarea id="text" rows="3">Testing Qwen3 integration</textarea><br>
    
    <label for="voiceSelect">Choose Voice:</label><br>
    <select id="voiceSelect">
        <optgroup label="Native Qwen3 Voices">
            <option value="vivian" selected>Vivian (Female)</option>
            <option value="serena">Serena (Female)</option>
            <option value="ono_anna">Ono Anna (Female)</option>
            <option value="sohee">Sohee (Female)</option>
            <option value="uncle_fu">Uncle Fu (Male)</option>
            <option value="ryan">Ryan (Male)</option>
            <option value="aiden">Aiden (Male)</option>
            <option value="eric">Eric (Male)</option>
            <option value="dylan">Dylan (Male)</option>
        </optgroup>
        <optgroup label="OpenAI-Compatible Aliases">
            <option value="alloy">Alloy (maps to Vivian)</option>
            <option value="echo">Echo (maps to Ryan)</option>
            <option value="fable">Fable (maps to Sophia)</option>
            <option value="nova">Nova (maps to Isabella)</option>
            <option value="onyx">Onyx (maps to Evan)</option>
            <option value="shimmer">Shimmer (maps to Lily)</option>
        </optgroup>
    </select><br>

    <button id="play">Generate & Play</button>
    <p id="status">Status: Ready</p>

    <script>
    document.getElementById('play').onclick = async () => {
        const statusText = document.getElementById('status');
        const playBtn = document.getElementById('play');
        
        statusText.innerText = "Status: Generating audio (please wait)...";
        playBtn.disabled = true; // Prevent spam clicking

        // Prepare the exact payload from your Postman test
        const payload = {
            text: document.getElementById('text').value,
            voice: document.getElementById('voiceSelect').value,
            speed: 1.0
        };

        try {
            // Hit the REST endpoint instead of the WebSocket
            const response = await fetch("http://127.0.0.1:8010/api/v1/synthesis", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            // Convert the response directly into an audio blob
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // Play the audio
            const audio = new Audio(audioUrl);
            audio.play();
            
            statusText.innerText = "Status: Playing audio...";
            
            // Reset status when audio finishes
            audio.onended = () => {
                statusText.innerText = "Status: Done";
                playBtn.disabled = false;
            };

        } catch (error) {
            console.error(error);
            statusText.innerText = "Status: Error - " + error.message;
            playBtn.disabled = false;
        }
    };
    </script>
</body>
</html>